name: package
on:
  push:
    branches: [ main, '**/copilot/**', 'copilot/**' ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build dual outputs
        run: node build.js

      - name: List outputs (debug)
        run: |
          echo "::group::tree dist_server"
          ls -la dist_server || true
          echo "::endgroup::"
          echo "::group::tree dist_local"
          ls -la dist_local || true
          echo "::endgroup::"

      - name: Verify assets (server)
        if: ${{ hashFiles('dist_server/index.html') != '' }}
        run: cd dist_server && node ../verify-assets.js

      - name: Verify assets (local)
        if: ${{ hashFiles('dist_local/index.html') != '' }}
        run: cd dist_local && node ../verify-assets.js

      - name: Create SERVER.zip
        if: ${{ hashFiles('dist_server/index.html') != '' }}
        run: |
          cd dist_server
          zip -r ../SERVER.zip .
          echo "SERVER.zip created with $(unzip -l ../SERVER.zip | tail -1 | awk '{print $2}') files"

      - name: Create LOCAL.zip
        if: ${{ hashFiles('dist_local/index.html') != '' }}
        run: |
          cd dist_local
          zip -r ../LOCAL.zip .
          echo "LOCAL.zip created with $(unzip -l ../LOCAL.zip | tail -1 | awk '{print $2}') files"

      - name: Upload SERVER.zip artifact
        if: ${{ hashFiles('SERVER.zip') != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: SERVER
          path: SERVER.zip
          retention-days: 30

      - name: Upload LOCAL.zip artifact
        if: ${{ hashFiles('LOCAL.zip') != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: LOCAL
          path: LOCAL.zip
          retention-days: 30
